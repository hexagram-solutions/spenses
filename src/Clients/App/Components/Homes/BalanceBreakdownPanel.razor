@using Spenses.App.Store.Homes
@using Spenses.Shared.Models.Homes
@using Spenses.App.Components.Members
@inherits Fluxor.Blazor.Web.Components.FluxorComponent

<MudPaper Class="pa-4">
    <MudStack>
        <MudText Typo="Typo.h5">Balance Breakdown</MudText>
        <div>
            <LoadingOverlay Visible="HomesState.Value.BalanceBreakdownRequesting"/>
            <MudExpansionPanels MultiExpansion="true">
                @foreach (var balance in BalanceBreakdown?.MemberBalances ?? [])
                {
                    <MudExpansionPanel IsExpanded>
                        <TitleContent>
                            <MemberNameDisplay Member="@balance.Member"/>
                        </TitleContent>
                        <ChildContent>
                            <MudTable Items="balance.Debts"
                                      Dense>
                                <HeaderContent>
                                    <MudTh>Owed to</MudTh>
                                    <MudTh>Total owed</MudTh>
                                    <MudTh>Total paid</MudTh>
                                    <MudTh>Balance owing</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Owed member">
                                        <MemberNameDisplay Member="@context.OwedTo"/>
                                    </MudTd>
                                    <MudTd DataLabel="Expenses">@context.TotalOwed</MudTd>
                                    <MudTd DataLabel="Payments">@context.TotalPaid</MudTd>
                                    <MudTd DataLabel="Balance owing">@context.BalanceOwing</MudTd>
                                </RowTemplate>
                            </MudTable>
                        </ChildContent>
                    </MudExpansionPanel>
                }
            </MudExpansionPanels>
        </div>
    </MudStack>
</MudPaper>

@code {

    [Parameter] [EditorRequired] public Guid HomeId { get; set; }

    [Parameter] [EditorRequired] public DateOnly PeriodStart { get; set; }

    [Parameter] [EditorRequired] public DateOnly PeriodEnd { get; set; }

    [Inject] private IState<HomesState> HomesState { get; set; } = null!;

    [Inject] private IDispatcher Dispatcher { get; set; } = null!;

    private BalanceBreakdown? BalanceBreakdown => HomesState.Value.BalanceBreakdown;

    protected override void OnInitialized()
    {
        base.OnInitialized();

        Refresh();
    }

    public void Refresh()
    {
        Dispatcher.Dispatch(new BalanceBreakdownRequestedAction(HomeId, PeriodStart, PeriodEnd));
    }

}

@page "/sign-up"
@using Spenses.App.Infrastructure
@using Spenses.Shared.Models.Identity
@inherits Fluxor.Blazor.Web.Components.FluxorComponent

<PageTitle>Sign up</PageTitle>

<h2>Sign up</h2>

<MudCard>
    @foreach (var error in IdentityState.Value.Errors)
    {
        switch (error)
        {
            case IdentityErrors.Register.InvalidEmail:
            case IdentityErrors.Register.InvalidUserName:
                @InvalidUserNameOrEmailError
                break;

            case IdentityErrors.Register.DuplicateEmail:
            case IdentityErrors.Register.DuplicateUserName:
                @DuplicateUserNameOrEmailError
                break;

            case IdentityErrors.Register.PasswordTooShort:
                @PasswordTooShortError
                break;

            case IdentityErrors.Register.PwnedPassword:
                @_pwnedPasswordError
                break;

            case IdentityErrors.Register.UserNameAsPassword:
            case IdentityErrors.Register.EmailAsPassword:
                @UserNameOrEmailAsPasswordError
                break;

            default:
                @GenericSignUpError(IdentityState.Value.Errors)
                break;
        }
    }

    <MudForm Model="RegisterRequest"
             @ref="FormRef"
             Validation="@(_validator.ValidateValue())">

        <MudCardContent>
            <MudTextField @bind-Value="RegisterRequest.Name"
                          Label="Name"
                          Placeholder="Hingle McCringleberry"
                          Required/>

            <MudTextField @bind-Value="RegisterRequest.Email"
                          Label="Email"
                          Placeholder="hmccringleberry@psu.edu"
                          Required/>

            <MudTextField @bind-Value="RegisterRequest.Password"
                          Label="Password"
                          InputType="InputType.Password"
                          Required/>
        </MudCardContent>
    </MudForm>

    <MudCardActions>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   Class="ml-auto"
                   OnClick="Register"
                   Disabled="IdentityState.Value.RegistrationRequesting">
            Sign up
        </MudButton>
    </MudCardActions>
</MudCard>

@code
{
    private RenderFragment InvalidUserNameOrEmailError => __builder =>
    {
        <MudAlert Severity="Severity.Error">
            The email address you entered is invalid.
        </MudAlert>
    };

    private RenderFragment DuplicateUserNameOrEmailError => __builder =>
    {
        <MudAlert Severity="Severity.Error">
            It looks like you may already have an account with us. Use your credentials to
            <MudLink Href="@Routes.Identity.Login()">log in.</MudLink>
        </MudAlert>
    };

    private RenderFragment PasswordTooShortError => __builder =>
    {
        <MudAlert Severity="Severity.Error">
            Passwords must have a minimum of 10 characters.
        </MudAlert>
    };

    private RenderFragment UserNameOrEmailAsPasswordError => __builder =>
    {
        <MudAlert Severity="Severity.Error">
            You cannot use your email address as your password.
        </MudAlert>
    };

    private readonly RenderFragment _pwnedPasswordError = __builder =>
    {
        <MudAlert Severity="Severity.Error">
            <p>
                The password you've entered appears in multiple public data breaches and is therefore insecure. Please enter a different password.
            </p>
            <p>
                See <FluentAnchor Href="https://haveibeenpwned.com/Passwords">this page</FluentAnchor> for more information.
            </p>
        </MudAlert>
    };

    private RenderFragment GenericSignUpError(string[] errors) => __builder =>
    {
        <MudAlert Severity="Severity.Error">
            <p>
                Unable to sign up:
            </p>
            <ul>
                @foreach (var error in errors)
                {
                    <li>@error</li>
                }
            </ul>
        </MudAlert>
    };
}
